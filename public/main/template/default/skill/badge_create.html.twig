<div class="section-header section-header--h2">
    <h2 class="section-header__title">{{ skill.title }}</h2>
</div>

<div class="w-full">
    <div class="w-full max-w-none px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col lg:flex-row gap-6 items-start">

            {# LEFT #}
            <div class="w-full min-w-0 lg:basis-2/3">
                <div class="bg-white border border-gray-30 rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-base font-semibold text-gray-900">{{ "Badge"|trans }}</h3>
                        <p class="mt-1 text-sm text-gray-600">{{ "Badge measures 200x200 pixels in PNG"|trans }}</p>
                    </div>

                    <form id="badge-form" action="{{ current_url }}" method="post" enctype="multipart/form-data" class="p-6 space-y-6">

                        {# Upload #}
                        <div class="min-w-0">
                            <label for="image" class="block text-sm font-medium text-gray-800">{{ "Image"|trans }}</label>

                            <div class="mt-2 min-w-0">
                                <input
                                        type="file"
                                        name="image"
                                        id="image"
                                        accept="image/*"
                                        class="block w-full max-w-full text-sm text-gray-700
                                           file:mr-4 file:py-2 file:px-4
                                           file:rounded-lg file:border-0
                                           file:bg-primary/10 file:text-primary
                                           hover:file:bg-primary/15
                                           border border-gray-30 rounded-lg px-3 py-2"
                                />
                            </div>

                            <div class="mt-3 flex items-center gap-2">
                                <span id="badge-status-pill"
                                      class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-semibold text-gray-700">
                                    •
                                </span>
                                <span id="badge-status-text" class="text-xs text-gray-600">
                                    {{ "No image selected"|trans }}
                                </span>
                            </div>

                            <p class="mt-2 text-xs text-gray-500">{{ "Badge measures 200x200 pixels in PNG"|trans }}</p>
                        </div>

                        {# Badge Studio (collapsed by default, NOT display:none) #}
                        <div
                                id="badge-studio-frame"
                                class="max-h-0 opacity-0 overflow-hidden pointer-events-none transition-all duration-200"
                        >
                            <div class="rounded-2xl border border-gray-30 bg-gray-10 p-4">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="min-w-0">
                                        <h4 class="text-sm font-semibold text-gray-900">Badge Studio</h4>
                                        <p class="mt-1 text-xs text-gray-600">
                                            {{ "Use the Badge Studio to create your own badge from within your platform"|trans }}
                                        </p>
                                    </div>

                                    <button
                                            id="btn-close-badge-studio"
                                            type="button"
                                            class="shrink-0 inline-flex items-center justify-center rounded-lg border border-gray-30 bg-white px-3 py-2 text-xs font-semibold text-gray-700 hover:bg-gray-50"
                                            aria-label="Close Badge Studio"
                                            title="Close"
                                    >✕</button>
                                </div>

                                <div class="mt-4">
                                    {# Keep structure/IDs used by studio.js #}
                                    <div id="studio">
                                        <div id="input" class="space-y-4">

                                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                <div class="space-y-3 min-w-0">
                                                    <div>
                                                        <label for="studio-template" class="block text-xs font-semibold text-gray-800">{{ "Templates"|trans }}</label>
                                                        <select
                                                                name="template"
                                                                id="studio-template"
                                                                data-path="{{ badge_studio.templates }}"
                                                                class="mt-1 block w-full rounded-lg border border-gray-30 bg-white px-3 py-2 text-sm"
                                                        >
                                                            <option value="template-1">{{ "Template"|trans }} 1</option>
                                                            <option value="template-2">{{ "Template"|trans }} 2</option>
                                                            <option value="template-3">{{ "Template"|trans }} 3</option>
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label for="studio-palette" class="block text-xs font-semibold text-gray-800">{{ "Palettes"|trans }}</label>
                                                        <select
                                                                name="palette"
                                                                id="studio-palette"
                                                                class="mt-1 block w-full rounded-lg border border-gray-30 bg-white px-3 py-2 text-sm"
                                                        >
                                                            <option
                                                                    value="palette-1"
                                                                    data-color-background="#CE001F"
                                                                    data-color-stitching="#FFF"
                                                                    data-color-border="#4C4F53"
                                                                    data-color-detail="#999"
                                                                    data-color-glyph="#FFF"
                                                            >{{ "Palette"|trans }} 1</option>

                                                            <option
                                                                    value="palette-2"
                                                                    data-color-background="#04A"
                                                                    data-color-stitching="#0AE"
                                                                    data-color-border="#0AE"
                                                                    data-color-detail="#FFF"
                                                                    data-color-glyph="#FFF"
                                                            >{{ "Palette"|trans }} 2</option>

                                                            <option
                                                                    value="palette-3"
                                                                    data-color-background="#11458B"
                                                                    data-color-stitching="#3EB48D"
                                                                    data-color-border="#3EB48D"
                                                                    data-color-detail="#FFF"
                                                                    data-color-glyph="#FFF"
                                                            >{{ "Palette"|trans }} 3</option>
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-800">{{ "Colors"|trans }}</label>
                                                        <div id="custom-palette" class="mt-2"></div>
                                                    </div>
                                                </div>

                                                <div class="md:col-span-3 min-w-0">
                                                    <div class="rounded-xl border border-gray-30 bg-white p-3 min-w-0 overflow-hidden">
                                                        <div id="output" class="min-h-[280px] relative"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                <div class="min-w-0">
                                                    <label for="studio-mask" class="block text-xs font-semibold text-gray-800">{{ "Mask"|trans }}</label>
                                                    <select
                                                            name="mask"
                                                            id="studio-mask"
                                                            data-path="{{ badge_studio.masks }}"
                                                            class="mt-1 block w-full rounded-lg border border-gray-30 bg-white px-3 py-2 text-sm"
                                                    >
                                                        <option value="">{{ "None"|trans }}</option>
                                                        <option value="lines">{{ "Lines"|trans }}</option>
                                                    </select>
                                                </div>

                                                <div class="min-w-0">
                                                    <label class="block text-xs font-semibold text-gray-800">{{ "Options"|trans }}</label>
                                                    <div id="options" class="mt-2 text-sm text-gray-600">
                                                        <i>{{ "None"|trans }}</i>
                                                    </div>
                                                </div>

                                                <div class="md:col-span-2 space-y-3 min-w-0">
                                                    <div>
                                                        <label for="glyph" class="block text-xs font-semibold text-gray-800">{{ "Icon"|trans }}</label>

                                                        <select
                                                                name="glyph"
                                                                id="glyph"
                                                                class="mt-1 block w-full rounded-lg border border-gray-30 bg-white px-3 py-2 text-sm"
                                                        >
                                                            <option value="">{{ "None"|trans }}</option>

                                                            {% if badge_studio.glyph_options is defined and badge_studio.glyph_options is not empty %}
                                                                {{ badge_studio.glyph_options|raw }}
                                                            {% else %}
                                                                <optgroup label="Basics">
                                                                    <option value="check">Check</option>
                                                                    <option value="times">Times</option>
                                                                    <option value="plus">Plus</option>
                                                                    <option value="minus">Minus</option>
                                                                    <option value="star">Star</option>
                                                                    <option value="star-fill">Star Fill</option>
                                                                    <option value="heart">Heart</option>
                                                                    <option value="bookmark">Bookmark</option>
                                                                    <option value="flag">Flag</option>
                                                                    <option value="tag">Tag</option>
                                                                    <option value="info-circle">Info</option>
                                                                    <option value="question-circle">Help</option>
                                                                    <option value="exclamation-triangle">Warning</option>
                                                                </optgroup>

                                                                <optgroup label="Learning">
                                                                    <option value="book">Book</option>
                                                                    <option value="file">File</option>
                                                                    <option value="file-edit">Edit File</option>
                                                                    <option value="folder">Folder</option>
                                                                    <option value="copy">Copy</option>
                                                                    <option value="pencil">Pencil</option>
                                                                    <option value="save">Save</option>
                                                                    <option value="calendar">Calendar</option>
                                                                    <option value="clock">Clock</option>
                                                                </optgroup>

                                                                <optgroup label="Communication">
                                                                    <option value="envelope">Envelope</option>
                                                                    <option value="comment">Comment</option>
                                                                    <option value="comments">Comments</option>
                                                                    <option value="bell">Bell</option>
                                                                    <option value="send">Send</option>
                                                                    <option value="volume-up">Volume</option>
                                                                </optgroup>

                                                                <optgroup label="Security">
                                                                    <option value="lock">Lock</option>
                                                                    <option value="unlock">Unlock</option>
                                                                    <option value="shield">Shield</option>
                                                                    <option value="key">Key</option>
                                                                </optgroup>

                                                                <optgroup label="Tech">
                                                                    <option value="cog">Cog</option>
                                                                    <option value="code">Code</option>
                                                                    <option value="database">Database</option>
                                                                    <option value="desktop">Desktop</option>
                                                                    <option value="mobile">Mobile</option>
                                                                    <option value="cloud">Cloud</option>
                                                                    <option value="wifi">WiFi</option>
                                                                </optgroup>

                                                                <optgroup label="Actions">
                                                                    <option value="upload">Upload</option>
                                                                    <option value="download">Download</option>
                                                                    <option value="trash">Trash</option>
                                                                    <option value="refresh">Refresh</option>
                                                                    <option value="search">Search</option>
                                                                    <option value="filter">Filter</option>
                                                                </optgroup>

                                                                <optgroup label="Legacy">
                                                                    <option value="archive">Archive</option>
                                                                    <option value="anchor">Anchor</option>
                                                                    <option value="android">Android</option>
                                                                    <option value="apple">Apple</option>
                                                                </optgroup>
                                                            {% endif %}
                                                        </select>

                                                        {# Some studio builds reference this #}
                                                        <select id="studio-glyph" class="hidden" aria-hidden="true" tabindex="-1"></select>
                                                    </div>

                                                    <div>
                                                        <label for="size-glyph" class="block text-xs font-semibold text-gray-800">{{ "Size"|trans }}</label>
                                                        <select
                                                                name="size-glyph"
                                                                id="size-glyph"
                                                                class="mt-1 block w-full rounded-lg border border-gray-30 bg-white px-3 py-2 text-sm"
                                                        >
                                                            <option value="big">{{ "Big"|trans }}</option>
                                                            <option value="medium" selected>{{ "Medium"|trans }}</option>
                                                            <option value="small">{{ "Small"|trans }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="flex items-center justify-center gap-3 pt-2">
                                                <a
                                                        id="set-custom-badge"
                                                        href="#"
                                                        class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-semibold text-white hover:opacity-90"
                                                >✓ {{ "Use this badge"|trans }}</a>

                                                <input type="hidden" id="badge_studio_image" name="badge_studio_image" />
                                            </div>

                                        </div>
                                    </div>

                                    {# Templates needed by studio.js (keep as-is) #}
                                    <template id="glyph-selector-template">
                                        <div id="glyph-selector" role="dialog" class="overlay hidden" aria-label="Select a glyph" tabIndex="0">
                                            <div class="header" style="position: relative;">
                                                <label class="title"></label>
                                                <button type="button" class="bs-glyph-close" aria-label="Close">×</button>
                                            </div>
                                            <div class="panel"><ul></ul></div>
                                        </div>
                                    </template>

                                    <template id="glyph-selector-item-template">
                                        <li>
                                            <input type="radio" name="glyph-selector-item" class="hidden" />
                                            <label></label>
                                        </li>
                                    </template>

                                    <template id="option-template">
                                        <label>
                                            <input type="checkbox" />
                                            <span>Label</span>
                                        </label>
                                    </template>

                                    <template id="close-button-template">
                                        <button type="button" class="close" aria-label="Close">×</button>
                                    </template>

                                    <template id="custom-color-template">
                                        <label>
                                            <input type="color" />
                                            <span>Label</span>
                                        </label>
                                    </template>

                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {# RIGHT #}
            <div class="w-full min-w-0 lg:basis-1/3 lg:sticky lg:top-6 self-start">
                <div class="bg-white border border-gray-30 rounded-2xl shadow-sm p-6 space-y-5 overflow-hidden">
                    <div>
                        <h3 class="text-base font-semibold text-gray-900">{{ "Badge preview"|trans }}</h3>
                        <p class="mt-1 text-sm text-gray-600">{{ "Upload an image or create one with Badge Studio."|trans }}</p>
                    </div>

                    <div class="flex justify-center">
                        <div class="w-[240px] max-w-full">
                            <div
                                    id="badge-container"
                                    class="{% if (badge_url|default('')) is empty %}hidden{% endif %} rounded-2xl border border-gray-30 bg-gray-10 p-3"
                            >
                                <img
                                        id="badge-preview"
                                        src="{{ badge_url|default('') }}"
                                        alt="{{ "Badge preview"|trans }}"
                                        class="w-full h-auto rounded-xl {% if (badge_url|default('')) is empty %}hidden{% endif %}"
                                />
                            </div>

                            <div
                                    id="badge-placeholder"
                                    class="{% if (badge_url|default('')) is not empty %}hidden{% endif %} rounded-2xl border border-dashed border-gray-300 bg-gray-10 p-6 text-center"
                            >
                                <div class="text-gray-500 text-sm">{{ "No image selected"|trans }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button
                                id="btn-save-badge"
                                type="submit"
                                form="badge-form"
                                disabled
                                class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90
                   disabled:opacity-50 disabled:cursor-not-allowed"
                        >{{ "Save badge"|trans }}</button>

                        <p class="text-xs text-gray-600">
                            {{ "Select an image (upload or Badge Studio) to enable saving."|trans }}
                        </p>
                        <a
                                id="btn-open-designer"
                                href="https://badge.design"
                                class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-white hover:opacity-90"
                                target="_blank"
                                rel="noopener noreferrer"
                        >{{ "Design a new badge"|trans }}</a>

                        <p class="text-xs text-gray-600">
                            {{ "Design a new badge, download it from the design tool and upload it on the platform."|trans }}
                        </p>

                        <button
                                id="btn-open-badge-studio"
                                type="button"
                                class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-primary px-4 py-2.5 text-sm font-semibold text-primary hover:bg-primary/10"
                        >{{ "Design with Badge Studio"|trans }}</button>

                        <p class="text-xs text-gray-600">
                            {{ "Use the Badge Studio to create your own badge from within your platform"|trans }}
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

{% autoescape false %}
    {{ badge_studio.script_js }}
{% endautoescape %}

<script>
  (function () {
    if (window.__ChamiloSkillBadgeNoSearchV2) return;
    window.__ChamiloSkillBadgeNoSearchV2 = true;

    const DEBUG = false;

    function log(msg, data) {
      if (!DEBUG) return;
      if (data !== undefined) console.log("[SkillBadge]", msg, data);
      else console.log("[SkillBadge]", msg);
    }

    function warn(msg, data) {
      if (data !== undefined) console.warn("[SkillBadge]", msg, data);
      else console.warn("[SkillBadge]", msg);
    }

    function $(id) { return document.getElementById(id); }

    // ---------------------------
    // Initial state from backend
    // ---------------------------
    const INITIAL_HAS_BADGE = {{ (badge_url|default('')) is not empty ? 'true' : 'false' }};
    const INITIAL_BADGE_SRC = {{ ((badge_url|default('')) is not empty ? (badge_url|default('')) : '')|json_encode|raw }};

    const TEXT_NO_IMAGE = {{ "No image selected"|trans|json_encode|raw }};
    const TEXT_CURRENT_BADGE = {{ "Current badge set"|trans|json_encode|raw }};
    const TEXT_READY_TO_SAVE = {{ "Badge ready to be saved"|trans|json_encode|raw }};
    const TEXT_SELECT_TO_SAVE = {{ "Select an image (upload or Badge Studio) to enable saving."|trans|json_encode|raw }};

    // ---------------------------
    // Status helpers
    // ---------------------------
    function setStatus(text, tone) {
      const pill = $("badge-status-pill");
      const label = $("badge-status-text");

      if (label) label.textContent = String(text || "");

      if (!pill) return;

      // tone: "neutral" | "success" | "warning"
      const t = String(tone || "neutral");

      pill.classList.remove(
        "border-gray-200", "bg-gray-50", "text-gray-700",
        "border-green-200", "bg-green-50", "text-green-700",
        "border-amber-200", "bg-amber-50", "text-amber-800"
      );

      if (t === "success") {
        pill.classList.add("border-green-200", "bg-green-50", "text-green-700");
        pill.textContent = "✓";
        return;
      }

      if (t === "warning") {
        pill.classList.add("border-amber-200", "bg-amber-50", "text-amber-800");
        pill.textContent = "!";
        return;
      }

      pill.classList.add("border-gray-200", "bg-gray-50", "text-gray-700");
      pill.textContent = "•";
    }

    function setSaveEnabled(enabled) {
      const btn = $("btn-save-badge");
      if (!btn) return;
      btn.disabled = !enabled;
    }

    function hasPendingSelection() {
      const hidden = $("badge_studio_image");
      const fileInput = $("image");

      const hasStudio = !!(hidden && String(hidden.value || "").trim().length > 0);
      const hasFile = !!(fileInput && fileInput.files && fileInput.files.length > 0);

      return hasStudio || hasFile;
    }

    // ---------------------------
    // Fast: detect the glyph "Search" label
    // ---------------------------
    function isSearchLabel(text) {
      const t = String(text || "").trim().toLowerCase();
      return t === "search" || t === "rechercher" || t === "buscar";
    }

    // ---------------------------
    // Hide the Search button (twig-side)
    // ---------------------------
    function hideStudioSearchButton() {
      const frame = $("badge-studio-frame");
      if (!frame) return;

      // Search button is usually inside the studio frame, created by studio.js
      const candidates = frame.querySelectorAll("button, input[type='button'], input[type='submit'], a");
      for (const el of candidates) {
        const label = (el.textContent || el.value || "");
        if (isSearchLabel(label)) {
          el.style.display = "none";
          el.setAttribute("aria-hidden", "true");
          el.setAttribute("tabindex", "-1");
          log("Search button hidden");
        }
      }
    }

    // Capture clicks only inside the studio frame (kept, in case studio re-adds it)
    document.addEventListener("click", function (e) {
      const frame = $("badge-studio-frame");
      if (!frame) return;

      const target = e.target && e.target.closest ? e.target.closest("button, a, input[type='button'], input[type='submit']") : null;
      if (!target) return;

      if (!target.closest("#badge-studio-frame")) return;

      const label = (target.textContent || target.value || "");
      if (isSearchLabel(label)) {
        e.preventDefault();
        e.stopImmediatePropagation();
        log("Blocked glyph search UI click");
      }
    }, true);

    // ---------------------------
    // Hide glyph selector modal (no custom CSS)
    // ---------------------------
    function hideGlyphSelectorModal() {
      const gs = $("glyph-selector");
      if (!gs) return;
      gs.classList.add("hidden");
      gs.setAttribute("aria-hidden", "true");
      gs.style.display = "none";
    }

    // ---------------------------
    // Studio open/close
    // ---------------------------
    function openStudio() {
      const frame = $("badge-studio-frame");
      if (!frame) return;

      frame.classList.remove("max-h-0", "opacity-0", "overflow-hidden", "pointer-events-none");
      frame.classList.add("max-h-[2400px]", "opacity-100", "overflow-visible", "pointer-events-auto");

      // Defer a bit so studio.js finishes initial DOM updates
      setTimeout(function () {
        hideGlyphSelectorModal();

        // Hide Search button after studio DOM is ready
        hideStudioSearchButton();

        window.dispatchEvent(new Event("resize"));
        const tpl = $("studio-template");
        if (tpl) tpl.dispatchEvent(new Event("change", { bubbles: true }));
        const pal = $("studio-palette");
        if (pal) pal.dispatchEvent(new Event("change", { bubbles: true }));

        updateOverlay();
        log("Badge Studio opened");
      }, 60);

      // Extra safety: studio.js can rebuild parts later
      setTimeout(hideStudioSearchButton, 250);
      setTimeout(hideStudioSearchButton, 600);
    }

    function closeStudio() {
      const frame = $("badge-studio-frame");
      if (!frame) return;

      frame.classList.remove("max-h-[2400px]", "opacity-100", "overflow-visible", "pointer-events-auto");
      frame.classList.add("max-h-0", "opacity-0", "overflow-hidden", "pointer-events-none");

      setTimeout(function () {
        window.dispatchEvent(new Event("resize"));
        log("Badge Studio closed");
      }, 60);
    }

    // ---------------------------
    // Preview helpers
    // ---------------------------
    function applyPreview(src) {
      const preview = $("badge-preview");
      const container = $("badge-container");
      const placeholder = $("badge-placeholder");

      if (preview) {
        preview.src = src;
        preview.classList.remove("hidden");
      }
      if (container) container.classList.remove("hidden");
      if (placeholder) placeholder.classList.add("hidden");
    }

    function clearStudioHiddenImage() {
      const hidden = $("badge_studio_image");
      if (hidden) hidden.value = "";
    }

    // ---------------------------
    // PrimeIcons helpers (cached)
    // ---------------------------
    let PRIME_OK = null;
    const PRIME_INFO_CACHE = new Map();

    function isPrimeIconsLoaded() {
      if (PRIME_OK !== null) return PRIME_OK;

      const i = document.createElement("i");
      i.className = "pi pi-check";
      i.style.position = "absolute";
      i.style.left = "-99999px";
      i.style.top = "-99999px";
      document.body.appendChild(i);

      const content = getComputedStyle(i, "::before").getPropertyValue("content");
      const family = (getComputedStyle(i).getPropertyValue("font-family") || "").toLowerCase();

      document.body.removeChild(i);

      PRIME_OK = !!content && content !== "none" && family.includes("primeicons");
      return PRIME_OK;
    }

    function normalizeHex(c) {
      if (!c) return "#ffffff";
      const s = String(c).trim();
      return s.startsWith("#") ? s : ("#" + s.replace(/^#/, ""));
    }

    function getGlyphColor() {
      const opt = document.querySelector("#studio-palette option:checked");
      const c = opt ? (opt.getAttribute("data-color-glyph") || (opt.dataset ? opt.dataset.colorGlyph : null)) : null;
      return normalizeHex(c || "#ffffff");
    }

    // Best-effort aliasing for legacy values
    const GLYPH_MAP = {
      android: ["mobile", "desktop", "code"],
      apple: ["bookmark", "star", "heart"],
      anchor: ["link", "bookmark", "tag"],
      archive: ["folder", "file", "bookmark"],
    };

    function getPrimeIconInfo(name) {
      const iconName = String(name || "").trim();
      if (!iconName) return null;

      const key = iconName.startsWith("pi-") ? iconName : ("pi-" + iconName);
      if (PRIME_INFO_CACHE.has(key)) return PRIME_INFO_CACHE.get(key);

      const cls = iconName.startsWith("pi-") ? iconName : ("pi-" + iconName);

      const el = document.createElement("i");
      el.className = "pi " + cls;
      el.style.position = "absolute";
      el.style.left = "-99999px";
      el.style.top = "-99999px";
      el.style.fontSize = "80px";
      document.body.appendChild(el);

      let content = getComputedStyle(el, "::before").getPropertyValue("content");
      const fontFamily = getComputedStyle(el).getPropertyValue("font-family") || "";
      const fontWeight = getComputedStyle(el).getPropertyValue("font-weight") || "400";

      document.body.removeChild(el);

      if (!content || content === "none" || !String(fontFamily).toLowerCase().includes("primeicons")) {
        PRIME_INFO_CACHE.set(key, null);
        return null;
      }

      let char = String(content).replace(/^["']|["']$/g, "");
      if (char.startsWith("\\")) {
        const hex = char.replace("\\", "");
        const code = parseInt(hex, 16);
        if (!Number.isNaN(code)) char = String.fromCharCode(code);
      }

      const info = { cls: "pi " + cls, char, fontFamily, fontWeight };
      PRIME_INFO_CACHE.set(key, info);
      return info;
    }

    function resolvePrimeIcon(value) {
      const v = String(value || "").trim();
      if (!v) return null;

      const candidates = GLYPH_MAP[v] || [v, "check"];
      for (const c of candidates) {
        const info = getPrimeIconInfo(c);
        if (info && info.char) return info;
      }
      return null;
    }

    function getGlyphSizePxForPreview() {
      const sel = $("size-glyph");
      const v = String(sel ? sel.value : "medium");
      if (v === "big") return 92;
      if (v === "small") return 62;
      return 78;
    }

    // ---------------------------
    // Raster extraction
    // ---------------------------
    function getRasterSrc() {
      const raster = $("raster");
      if (raster) {
        if (raster.tagName === "IMG") return raster.getAttribute("src") || "";
        if (raster.tagName === "CANVAS") {
          try { return raster.toDataURL("image/png"); } catch (e) { return ""; }
        }
      }

      const out = $("output");
      if (!out) return "";

      const img = out.querySelector("img");
      if (img && img.getAttribute("src")) return img.getAttribute("src");

      const canvas = out.querySelector("canvas");
      if (canvas) {
        try { return canvas.toDataURL("image/png"); } catch (e) { return ""; }
      }

      return "";
    }

    function loadImage(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src;
      });
    }

    // ---------------------------
    // Overlay preview (no custom CSS, Tailwind classes)
    // ---------------------------
    function ensureOverlay() {
      const out = $("output");
      if (!out) return null;

      let overlay = $("pi-glyph-overlay");
      if (overlay) return overlay;

      overlay = document.createElement("div");
      overlay.id = "pi-glyph-overlay";
      overlay.className = "absolute inset-0 hidden items-center justify-center pointer-events-none";
      overlay.innerHTML = '<i aria-hidden="true"></i>';
      out.appendChild(overlay);
      return overlay;
    }

    function updateOverlay() {
      const overlay = ensureOverlay();
      if (!overlay) return;

      // Hide Search button if studio rebuilds the icon area
      hideStudioSearchButton();

      const glyphSel = $("glyph");
      const value = glyphSel ? String(glyphSel.value || "").trim() : "";
      const i = overlay.querySelector("i");

      if (!value || !isPrimeIconsLoaded()) {
        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
        if (i) i.className = "";
        return;
      }

      const info = resolvePrimeIcon(value);
      if (!info) {
        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
        return;
      }

      overlay.classList.remove("hidden");
      overlay.classList.add("flex");

      const size = getGlyphSizePxForPreview();
      const color = getGlyphColor();

      if (i) {
        i.className = info.cls;
        i.style.color = color;
        i.style.fontSize = size + "px";
        i.style.lineHeight = "1";
      }
    }

    // ---------------------------
    // Build final PNG (base + PrimeIcons glyph char)
    // ---------------------------
    async function buildFinalAndApply() {
      const rasterSrc = getRasterSrc();
      if (!rasterSrc) {
        warn("No raster found. Badge Studio output might not be ready.");
        return;
      }

      const baseImg = await loadImage(rasterSrc);
      if (!baseImg) {
        warn("Base raster could not be loaded.");
        return;
      }

      const w = baseImg.naturalWidth || 200;
      const h = baseImg.naturalHeight || 200;

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(baseImg, 0, 0, w, h);

      const glyphSel = $("glyph");
      const value = glyphSel ? String(glyphSel.value || "").trim() : "";

      if (value && isPrimeIconsLoaded()) {
        const info = resolvePrimeIcon(value);
        if (info && info.char) {
          try {
            if (document.fonts && document.fonts.load) {
              await document.fonts.load(`${info.fontWeight} 80px ${info.fontFamily}`, info.char);
              await document.fonts.ready;
            }
          } catch (e) {}

          const sizeSel = $("size-glyph") ? String($("size-glyph").value || "medium") : "medium";
          const rel = (sizeSel === "big") ? 0.50 : (sizeSel === "small") ? 0.34 : 0.42;
          const sizePx = Math.round(Math.min(w, h) * rel);

          ctx.fillStyle = getGlyphColor();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = `${info.fontWeight} ${sizePx}px ${info.fontFamily}`;
          ctx.fillText(info.char, w / 2, h / 2);

          log("Glyph drawn using PrimeIcons", { value, sizePx });
        }
      }

      const finalSrc = canvas.toDataURL("image/png");

      const hidden = $("badge_studio_image");
      if (hidden) hidden.value = finalSrc;

      const fileInput = $("image");
      if (fileInput) fileInput.value = "";

      applyPreview(finalSrc);

      // Enable saving only after selection
      setSaveEnabled(true);
      setStatus(TEXT_READY_TO_SAVE, "success");

      log("Final badge applied", { length: String(finalSrc).length });
    }

    // ---------------------------
    // Hooks
    // ---------------------------
    function hook() {
      hideGlyphSelectorModal();

      const btnOpen = $("btn-open-badge-studio");
      const btnClose = $("btn-close-badge-studio");
      const fileInput = $("image");
      const form = $("badge-form");

      // Default: disabled until user selects something
      setSaveEnabled(false);

      if (INITIAL_HAS_BADGE && INITIAL_BADGE_SRC) {
        applyPreview(INITIAL_BADGE_SRC);
        setStatus(TEXT_CURRENT_BADGE, "success");
        // Keep save disabled until user changes something
      } else {
        setStatus(TEXT_NO_IMAGE, "neutral");
      }

      if (btnOpen) btnOpen.addEventListener("click", openStudio);
      if (btnClose) btnClose.addEventListener("click", closeStudio);

      if (fileInput) {
        fileInput.addEventListener("change", function () {
          const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
          if (!file) return;

          clearStudioHiddenImage();

          const url = URL.createObjectURL(file);
          applyPreview(url);

          setSaveEnabled(true);
          setStatus(TEXT_READY_TO_SAVE, "success");

          log("File selected for preview", { name: file.name, size: file.size });
        });
      }

      // Prevent "save" if nothing was selected (avoid confusion)
      if (form) {
        form.addEventListener("submit", function (e) {
          if (!hasPendingSelection()) {
            e.preventDefault();
            setSaveEnabled(false);
            setStatus(TEXT_SELECT_TO_SAVE, "warning");
            log("Submit blocked: no selection");
          }
        });
      }

      // Update overlay on explicit changes only (cheap)
      document.addEventListener("change", function (e) {
        const t = e.target;
        if (!t || !t.id) return;

        if (t.id === "glyph" || t.id === "size-glyph" || t.id === "studio-palette") {
          updateOverlay();
          hideStudioSearchButton();
        }
      }, true);

      // Capture click BEFORE studio handlers (ensures final image is generated)
      document.addEventListener("click", function (e) {
        const btn = e.target && e.target.closest ? e.target.closest("#set-custom-badge") : null;
        if (!btn) return;

        e.preventDefault();
        e.stopImmediatePropagation();

        buildFinalAndApply();
      }, true);

      // Hide Search button early if studio HTML is already present
      hideStudioSearchButton();

      log("UI hooks ready");
    }

    if (document.readyState !== "loading") hook();
    else document.addEventListener("DOMContentLoaded", hook);
  })();
</script>
