{% if exercisefocused.show_region %}
    {% set enable_time_limit = 'true' == exercisefocused.plugin_info.obj.get('enable_time_limit') %}
    {% set time_limit = exercisefocused.plugin_info.obj.get('time_limit') %}
    {% set enable_outfocused_limit = 'true' == exercisefocused.plugin_info.obj.get('enable_outfocused_limit') %}
    {% set outfocused_limit = exercisefocused.plugin_info.obj.get('outfocused_limit') %}

<script>
    $(function () {
        var $exerciseFocused = $("#exercisefocused-block").appendTo('body');
        var $timeLimitBlock = $exerciseFocused.find('#time-limit-block');
        var $timeLimitTarget = $exerciseFocused.find('#time-limit-target');
        var $outfocusedLimitBlock = $exerciseFocused.find('#outfocused-limit-block');
        var $outfocusedLimitTarget = $exerciseFocused.find('#outfocused-limit-target');

        var $backdrop = $('<div>')
            .addClass('exercisefocused-backdrop text-danger')
            .attr('data-alert', '{{ 'AlertBeforeLeaving'|get_plugin_lang('ExerciseFocusedPlugin') }}');

        $backdrop.appendTo('body');

        var secToken = "{{ exercisefocused.sec_token }}";
        var initDocumentTitle = document.title;
        var countdownInterval;
        var remainingTime;
        var enableTimeLimit = {{ enable_time_limit ? 'true' : 'false' }};
        var enableOutfocusedLimit = {{ enable_outfocused_limit ? 'true' : 'false' }};

        {% if enable_outfocused_limit %}
            var remainingOutfocused = {{ exercisefocused.remaining_outfocused }};
        {% endif %}

        function finishExam(examType) {
            $(window).off("blur", onBlur)
            $(window).off("focus", onFocus)

            if (1 === examType) {
                save_now_all('validate');
            } else if (2 === examType) {
                window.quizTimeEnding = true;
                $('[name="save_now"]').trigger('click');
            }
        }

        {% if enable_time_limit %}
            function updateCountdown() {
                var seconds = remainingTime;
                var strSeconds = `${seconds.toString().padStart(2, '0')}`;

                $timeLimitTarget.text(strSeconds);
                document.title = $timeLimitTarget.parent().text();

                remainingTime--;

                if (remainingTime < 0) {
                    clearInterval(countdownInterval);

                    sendAction('time_limit', function (response) {
                        finishExam(response.type)
                    });
                }
            }
        {% endif %}

        function sendAction(action, callback) {
            $.ajax({
                url: "{{ _p.web_plugin }}exercisefocused/pages/log.php",
                data: {
                    action: action,
                    exercisefocused_sec_token: secToken,
                },
                success: function (response) {
                    if (!response) {
                        return;
                    }

                    secToken = response.sec_token;

                    if (callback) {
                        callback(response)
                    }
                },
            });
        }

        function onBlur() {
            $exerciseFocused.show();

            if (enableOutfocusedLimit) {
                if (remainingOutfocused <= 0) {
                    $outfocusedLimitBlock.find('p').text("{{ 'OutfocusedLimitExceeded'|get_plugin_lang('ExerciseFocusedPlugin')|escape('js') }}");
                    $timeLimitBlock.hide();

                    sendAction('outfocused_limit', function (response) {
                        finishExam(response.type)
                    });

                    return;
                } else {
                    $outfocusedLimitTarget.text(remainingOutfocused);
                }

                remainingOutfocused--;
            }

            sendAction('outfocused');

            remainingTime = {{ time_limit }};

            {% if enable_time_limit %}
                updateCountdown();

                countdownInterval = window.setInterval(updateCountdown, 1000);
            {% else %}
                document.title = "{{ 'WindowTitleOutfocused'|get_plugin_lang('ExerciseFocusedPlugin')|escape('js') }}";
            {% endif %}
        }

        function onFocus() {
            sendAction('return');

            document.title = initDocumentTitle;

            $exerciseFocused.hide();

            {% if enable_time_limit %}
                clearInterval(countdownInterval);
            {% endif %}
        }

        $(window).on("blur", onBlur)
        $(window).on("focus", onFocus)

        $('body').on('click', 'a, button', function (e) {
            var $el = $(e.target);

            if (0 === $el.parents('form#exercise_form').length) {
                e.preventDefault();
            }
        });
    })
</script>
{% endif %}