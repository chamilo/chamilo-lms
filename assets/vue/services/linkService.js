import { ENTRYPOINT } from "../config/entrypoint"
import axios from "axios"
import baseService from "./baseService"

export default {
  /**
   * @param {Number|String} linkId
   * @param {FormData} imageData
   */
  uploadImage: async (linkId, imageData) => {
    const endpoint = `${ENTRYPOINT}links/${linkId}/upload-image`
    const response = await axios.post(endpoint, imageData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    })
    return response.data
  },

  /**
   * @param {Object} params
   */
  getLinks: async (params) => {
    const response = await axios.get(ENTRYPOINT + "links/", { params })

    return response.data
  },

  /**
   * @param {Number|String} linkId
   */
  getLink: async (linkId) => {
    const response = await axios.get(ENTRYPOINT + "links/" + linkId + "/details/")

    return response.data
  },

  /**
   * @param {Object} data
   */
  createLink: async (data) => {
    const endpoint = `${ENTRYPOINT}links`

    const response = await axios.post(endpoint, data)

    return response.data
  },

  /**
   * @param {Number|String} linkId
   * @param {Object} data
   */
  updateLink: async (linkId, data) => {
    const endpoint = `${ENTRYPOINT}links/${linkId}`
    data.id = linkId

    const response = await axios.put(endpoint, data)

    return response.data
  },

  /**
   * @param {number} linkId
   * @param {boolean} visible
   * @param {number} cid
   * @param {number} sid
   * @returns {Promise<Object>}
   */
  toggleLinkVisibility: async (linkId, visible, cid, sid) => {
    const endpoint = `${ENTRYPOINT}links/${linkId}/toggle_visibility?cid=${cid}&sid=${sid}`
    const response = await axios.put(endpoint, { visible })
    return response.data
  },

  /**
   * Move link (reorder) and optionally move between categories.
   *
   * @param {number|string} linkId
   * @param {number} position
   * @param {{categoryId?: number|null, cid?: number|null, sid?: number|null}} opts
   */
  moveLink: async (linkId, position, opts = {}) => {
    const cid = opts.cid ?? null
    const sid = opts.sid ?? null

    const query = []
    if (cid !== null) query.push(`cid=${encodeURIComponent(cid)}`)
    if (sid !== null) query.push(`sid=${encodeURIComponent(sid)}`)

    const endpoint = `${ENTRYPOINT}links/${linkId}/move` + (query.length ? `?${query.join("&")}` : "")

    const payload = { position }

    if (Object.prototype.hasOwnProperty.call(opts, "categoryId")) {
      payload.categoryId = opts.categoryId ?? 0
    }

    const response = await axios.put(endpoint, payload)
    return response.data
  },

  /**
   * Export links to a real PDF generated by the backend.
   * Uses multipart/form-data as defined in the API resource.
   *
   * @param {"pdf"} format
   * @param {{cid:number, sid?:number}} params
   */
  exportLinks: async (format, params) => {
    const endpoint = `${ENTRYPOINT}links/export?format=${encodeURIComponent(format)}`

    const formData = new FormData()
    formData.append("cid", String(params.cid))

    if (params.sid !== undefined && params.sid !== null && Number(params.sid) > 0) {
      formData.append("sid", String(params.sid))
    }

    // responseType 'blob' is required to download a real PDF file.
    return axios.post(endpoint, formData, { responseType: "blob" })
  },

  /**
   * @param {Number|String} linkId
   */
  deleteLink: async (linkId) => {
    const endpoint = `${ENTRYPOINT}links/${linkId}`
    const response = await axios.delete(endpoint)

    return response.data
  },

  getCategories: async (parentId) => {
    const response = await axios.get(`${ENTRYPOINT}link_categories?resourceNode.parent=${parentId}`)

    return response.data["hydra:member"]
  },

  /**
   * @param {Number|String} categoryId
   */
  getCategory: async (categoryId) => {
    const response = await axios.get(ENTRYPOINT + "link_categories/" + categoryId)

    return response.data
  },

  /**
   * @param {Object} data
   */
  createCategory: async (data) => {
    const endpoint = `${ENTRYPOINT}link_categories`
    const response = await axios.post(endpoint, data)

    return response.data
  },

  /**
   * @param {Number|String} categoryId
   * @param {Object} data
   */
  updateCategory: async (categoryId, data) => {
    const endpoint = `${ENTRYPOINT}link_categories/${categoryId}`
    const response = await axios.put(endpoint, data)

    return response.data
  },

  /**
   * @param {Number|String} categoryId
   */
  deleteCategory: async (categoryId) => {
    const endpoint = `${ENTRYPOINT}link_categories/${categoryId}`
    const response = await axios.delete(endpoint)

    return response.data
  },

  /**
   * @param {number} categoryId
   * @param {boolean} visible
   * @param {number} cid
   * @param {number} sid
   */
  toggleCategoryVisibility: async (categoryId, visible, cid, sid) => {
    const endpoint = `${ENTRYPOINT}link_categories/${categoryId}/toggle_visibility?cid=${cid}&sid=${sid}`
    const response = await axios.put(endpoint, { visible })

    return response.data
  },

  /**
   * Checks if the URL is valid.
   * @param {String} url The URL to be checked.
   * @param linkId
   */
  checkLink: async (url, linkId) => {
    const endpoint = `${ENTRYPOINT}links/${linkId}/check`
    const response = await axios.get(endpoint, { params: { url } })

    return response.data
  },
}
