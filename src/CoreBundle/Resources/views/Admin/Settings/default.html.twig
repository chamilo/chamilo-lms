{% extends "@ChamiloCore/Layout/layout_one_col.html.twig" %}
{% from '@ChamiloCore/Admin/Settings/actions.html.twig' import update %}
{% set namespace = app.request.get('namespace') %}

{% block content %}
    <div class="flex">
        <div class="w-1/5">
            {% include '@ChamiloCore/Admin/Settings/menu.html.twig' %}
        </div>
        <div class="w-4/5">
            <div class="q-card p-4">

                <form class="w-full form-horizontal"
                      action="{{ path('chamilo_platform_settings_search', {'keyword': keyword}) }}"
                      method="post"
                >
                    {{ form_widget(search_form) }}
                </form>

                <hr class="my-6 border-gray-25" />

                <div class="row">
                    <div class="col-md-12 w-full max-w-none">
                        <div class="box box-primary">
                            <div class="box-body w-full max-w-none">
                                {% if namespace == 'ai_helpers' %}
                                    <div class="mb-6 p-5 rounded-lg border border-gray-50 shadow-sm bg-white hover:shadow transition" style="width:100%;max-width:none;">
                                        <div class="flex justify-between items-start mb-3 border-l-4 border-primary pl-4">
                                            <h3 class="text-gray-90 text-body-1 font-semibold">
                                                {{ "EU AI Act – Transparency & risk notice"|trans }}
                                            </h3>
                                        </div>

                                        <div class="mb-4 text-gray-80 text-body-2 leading-relaxed">
                                            {{ "Under the EU Artificial Intelligence Act (Regulation (EU) 2024/1689), AI systems used in education are generally classified as “high-risk”.
    This software itself is <strong>not</strong> an AI system, but it can integrate optional internal or external AI systems—depending on your configuration—to enhance user task performance.
    These systems could access personal data <em>only if</em> users include such data in their prompts. By design, this software does not share personal data with AI systems without the user's active input.
    By default, all AI features are disabled."|trans|raw }}
                                        </div>

                                        <div class="border-t border-gray-25 pt-4">
                                            <h4 class="text-gray-90 text-body-2 font-semibold mb-2">
                                                {{ "Admin responsibility & disclosures"|trans }}
                                            </h4>
                                            <p class="text-gray-80 text-body-2 leading-relaxed mb-0">
                                                {{ "This configuration page details each AI feature and its purpose. As a deployer, you should review them carefully and update your GDPR-compliant data privacy policies to reflect the options you enable.
    While most AI features do not directly share personal data with external systems, user prompts sent to AI may inadvertently include personal information. As a deployer, <strong>you are responsible</strong> for informing users of this risk.
    For transparency, future releases may show non-intrusive end-user tags indicating that certain content or feedback was generated with the help of AI."|trans|raw }}
                                            </p>
                                        </div>
                                    </div>
                                {% endif %}
                                {{ form_errors(form) }}
                                <form
                                        class="form-horizontal !w-full !max-w-none"
                                        action="{{ path('chamilo_platform_settings', { 'namespace': namespace, 'keyword': keyword } ) }}"
                                        method="post"
                                        novalidate
                                >
                                    {% set verticalChoiceFields = ['active_tools_on_create', 'course_hide_tools'] %}

                                    {% for field in form %}
                                        {% set fieldName = field.vars.name %}
                                        {% set isHidden  = 'hidden' in field.vars.block_prefixes %}

                                        {% set isLockedOnMain =
                                            locked_map is defined
                                            and locked_map[fieldName] is defined
                                            and locked_map[fieldName] == 1
                                        %}

                                        {% set hideOnSubUrlBecauseLocked =
                                            current_url_id is defined
                                            and current_url_id != 1
                                            and isLockedOnMain
                                        %}

                                        {% set isDisabledOnSubUrl =
                                            current_url_id is defined
                                            and current_url_id != 1
                                            and (
                                            (changeable_map is defined and changeable_map[fieldName] is defined and not changeable_map[fieldName])
                                            or isLockedOnMain
                                            )
                                        %}

                                        {% if hideOnSubUrlBecauseLocked %}
                                            {# Do not show locked settings on sub-URLs.
                                               Render them hidden/disabled so Symfony does not re-render them elsewhere. #}
                                            <div class="hidden">
                                                {% if field.vars.compound is defined and field.vars.compound %}
                                                    {% for child in field %}
                                                        {{ form_widget(child, { attr: { disabled: 'disabled' } }) }}
                                                    {% endfor %}
                                                {% else %}
                                                    {{ form_widget(field, { attr: { disabled: 'disabled' } }) }}
                                                {% endif %}
                                            </div>
                                        {% elseif isHidden %}
                                            {{ form_widget(field) }}
                                        {% else %}
                                            <div class="mb-6 p-5 rounded-lg border border-gray-50 shadow-sm bg-white hover:shadow transition" style="width:100%;max-width:none;">
                                                <div class="flex justify-between items-start mb-3 border-l-4 border-primary pl-4">
                                                    <h3 class="text-gray-90 text-body-1 font-semibold">
                                                        {{ field.vars.label|trans }}
                                                    </h3>

                                                    <div class="flex items-center gap-2">
                                                        {% if template_map[fieldName] is defined %}
                                                            <a href="#"
                                                               class="text-info hover:text-info-dark show-template flex items-center gap-2"
                                                               data-template-id="{{ template_map[fieldName] }}"
                                                               title="{{ 'Show JSON Template'|trans }}">
                                                                <i class="mdi mdi-information-outline text-info text-lg"></i>
                                                                <span class="text-body-2">{{ 'Show JSON Template'|trans }}</span>
                                                            </a>
                                                        {% endif %}

                                                        {# Debug icon on test servers (keep original behavior) #}
                                                        {% set serverType = platform.server_type ?? (settings.platform.server_type ?? null) %}
                                                        {% if serverType == 'test' %}
                                                            <span
                                                                    class="ml-1 text-gray-60 text-lg flex items-center cursor-default debug-setting-icon"
                                                                    title="{{ namespace ~ '.' ~ fieldName }}"
                                                                    role="img"
                                                                    aria-hidden="true"
                                                                    data-field-id="{{ field.vars.id }}"
                                                                    data-namespace="{{ namespace }}"
                                                                    data-field-name="{{ fieldName }}"
                                                                    {% if template_map[fieldName] is defined %}
                                                                        data-template-id="{{ template_map[fieldName] }}"
                                                                    {% endif %}
                                                            >
                                                                <i class="mdi mdi-alphabetical course-tool__icon bg-primary-bgdisabled text-base" aria-hidden="true"></i>
                                                            </span>
                                                        {% endif %}

                                                        {# MultiURL changeable eye + access_url_locked behavior #}
                                                        {% if changeable_map is defined %}
                                                            {% set changeable = changeable_map[fieldName] is defined ? changeable_map[fieldName] : 1 %}

                                                            {% if isLockedOnMain %}
                                                                {# Main URL: show eye-off but NOT clickable when access_url_locked=1 #}
                                                                <span
                                                                        class="ml-1 text-gray-50 text-lg flex items-center cursor-not-allowed"
                                                                        title="{{ 'Setting is globally locked (access_url_locked=1)'|trans }}"
                                                                >
                                                                    <i class="mdi mdi-eye-off text-gray-50 text-xl"></i>
                                                                    <i class="mdi mdi-lock-outline text-gray-50 text-lg ml-1"></i>
                                                                </span>
                                                            {% elseif can_toggle_multiurl_setting %}
                                                                {# Main URL + admin: clickable toggle #}
                                                                <button
                                                                        type="button"
                                                                        class="ml-1 toggle-changeable flex items-center justify-center"
                                                                        data-variable="{{ fieldName }}"
                                                                        data-status="{{ changeable }}"
                                                                        title="{{ changeable ? 'Setting is editable on sub-URLs'|trans : 'Setting locked for sub-URLs'|trans }}"
                                                                >
                                                                    {% if changeable %}
                                                                        <i class="mdi mdi-eye text-primary text-xl"></i>
                                                                    {% else %}
                                                                        <i class="mdi mdi-eye-off text-gray-50 text-xl"></i>
                                                                    {% endif %}
                                                                </button>
                                                            {% else %}
                                                                {# Other URLs or non-privileged admins: read-only indicator #}
                                                                <span
                                                                        class="ml-1 text-gray-50 text-lg flex items-center cursor-default"
                                                                        title="{{ changeable ? 'Setting is editable on sub-URLs'|trans : 'Setting locked for sub-URLs'|trans }}"
                                                                >
                                                                    {% if changeable %}
                                                                        <i class="mdi mdi-eye text-gray-50 text-xl"></i>
                                                                    {% else %}
                                                                        <i class="mdi mdi-eye-off text-gray-50 text-xl"></i>
                                                                    {% endif %}
                                                                </span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <div class="mb-2">
                                                    {% if fieldName in verticalChoiceFields
                                                        and field.vars.expanded
                                                        and field.vars.multiple %}

                                                        <div class="flex flex-col gap-2">
                                                            {% for child in field %}
                                                                {% set childAttr = isDisabledOnSubUrl ? { disabled: 'disabled' } : {} %}
                                                                <label class="inline-flex items-center gap-2">
                                                                    {{ form_widget(child, { attr: childAttr }) }}
                                                                    <span>{{ child.vars.label }}</span>
                                                                </label>
                                                            {% endfor %}
                                                        </div>

                                                    {% else %}
                                                        {# Build base attributes and add disabled only when needed #}
                                                        {% set baseAttr = {
                                                            class: 'w-full rounded border border-gray-25 focus:border-primary focus:ring focus:ring-primary/30 transition'
                                                        } %}
                                                        {% set widgetAttr = isDisabledOnSubUrl
                                                            ? baseAttr|merge({ disabled: 'disabled' })
                                                            : baseAttr
                                                        %}

                                                        {{ form_widget(field, { attr: widgetAttr }) }}
                                                    {% endif %}
                                                </div>

                                                {% if field.vars.help is not empty %}
                                                    <p class="text-gray-50 text-body-2 italic pl-3">{{ field.vars.help|raw }}</p>
                                                {% endif %}

                                                {{ form_errors(field) }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}

                                    {{ update() }}
                                </form>

                                {# Extra diagnostics for search namespace (Xapian + converters), displayed AFTER all options #}
                                {% if namespace == 'search'
                                    and search_diagnostics is defined
                                    and search_diagnostics is not null
                                    and search_diagnostics.enabled %}
                                    <div class="mt-8">
                                        <div class="flex items-center justify-between mb-3">
                                            <h3 class="text-gray-90 text-body-1 font-semibold">
                                                {{ 'Search engine environment'|trans }}
                                            </h3>

                                            <button
                                                    type="button"
                                                    id="openXapianHelp"
                                                    class="inline-flex items-center gap-1 text-info hover:text-info-dark text-body-2"
                                            >
                                                <i class="mdi mdi-information-outline text-lg"></i>
                                                <span>{{ 'How to install Xapian bindings'|trans }}</span>
                                            </button>
                                        </div>

                                        <table class="min-w-full text-sm border border-gray-25 rounded overflow-hidden">
                                            <thead class="bg-gray-10">
                                            <tr>
                                                <th class="px-3 py-2 text-left">{{ 'Setting'|trans }}</th>
                                                <th class="px-3 py-2 text-left">{{ 'Status'|trans }}</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for row in search_diagnostics.status_rows %}
                                                <tr class="border-t border-gray-15">
                                                    <td class="px-3 py-2">{{ row.label|raw }}</td>
                                                    <td class="px-3 py-2">
                                                        {% if row.ok %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-success-10 text-success">
                                                                <i class="mdi mdi-check-circle-outline mr-1"></i>
                                                                {{ 'OK'|trans }}
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-danger-10 text-danger">
                                                                <i class="mdi mdi-close-circle-outline mr-1"></i>
                                                                {{ 'Missing'|trans }}
                                                            </span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>

                                    {% if search_diagnostics.tools_warning %}
                                        <p class="text-body-2 text-gray-60 mt-4 mb-4">
                                            {{ search_diagnostics.tools_warning|raw }}
                                        </p>
                                    {% endif %}

                                    {% if search_diagnostics.tools is not empty %}
                                        <div class="mb-2">
                                            <h3 class="text-gray-90 text-body-1 font-semibold mb-3 mt-4">
                                                {{ 'Programs needed to convert files'|trans }}
                                            </h3>

                                            <table class="min-w-full text-sm border border-gray-25 rounded overflow-hidden">
                                                <thead class="bg-gray-10">
                                                <tr>
                                                    <th class="px-3 py-2 text-left">{{ 'Software program'|trans }}</th>
                                                    <th class="px-3 py-2 text-left">{{ 'Path'|trans }}</th>
                                                    <th class="px-3 py-2 text-left">{{ 'Status'|trans }}</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for tool in search_diagnostics.tools %}
                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2">{{ tool.name }}</td>
                                                        <td class="px-3 py-2">{{ tool.path }}</td>
                                                        <td class="px-3 py-2">
                                                            {% if tool.ok %}
                                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-success-10 text-success">
                                                                    <i class="mdi mdi-check-circle-outline mr-1"></i>
                                                                    {{ 'Installed'|trans }}
                                                                </span>
                                                            {% else %}
                                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-danger-10 text-danger">
                                                                    <i class="mdi mdi-alert-circle-outline mr-1"></i>
                                                                    {{ 'Not installed'|trans }}
                                                                </span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>

                                            {# --- Add this block right after the tools table --- #}
                                            <div class="mt-4 p-4 rounded-lg border border-gray-25 bg-gray-10">
                                                <h4 class="text-gray-90 text-body-2 font-semibold mb-2">
                                                    {{ 'Supported file formats and required programs'|trans }}
                                                </h4>

                                                <p class="text-body-2 text-gray-70 mb-3">
                                                    {{ 'Xapian indexes plain text only. For binary/external formats, Chamilo must first extract text using the programs below.'|trans }}
                                                </p>

                                                <table class="min-w-full text-sm border border-gray-25 rounded overflow-hidden bg-white">
                                                    <thead class="bg-gray-10">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left">{{ 'File extension(s)'|trans }}</th>
                                                        <th class="px-3 py-2 text-left">{{ 'Extractor program'|trans }}</th>
                                                        <th class="px-3 py-2 text-left">{{ 'Typical source formats'|trans }}</th>
                                                        <th class="px-3 py-2 text-left">{{ 'Notes'|trans }}</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.pdf</code></td>
                                                        <td class="px-3 py-2"><code>pdftotext</code></td>
                                                        <td class="px-3 py-2">{{ 'PDF documents'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Works on text-based PDFs. Scanned/image-only PDFs may return empty output unless OCR is used.'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.ps</code></td>
                                                        <td class="px-3 py-2"><code>ps2pdf</code></td>
                                                        <td class="px-3 py-2">{{ 'PostScript files'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Used for PostScript-to-PDF conversion when needed by the extraction pipeline.'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.doc</code></td>
                                                        <td class="px-3 py-2"><code>catdoc</code></td>
                                                        <td class="px-3 py-2">{{ 'Legacy Microsoft Word (binary)'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Applies to older .doc files (not .docx).'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.rtf</code></td>
                                                        <td class="px-3 py-2"><code>unrtf</code></td>
                                                        <td class="px-3 py-2">{{ 'Rich Text Format'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Extracts text content from RTF documents.'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.ppt</code></td>
                                                        <td class="px-3 py-2"><code>catppt</code></td>
                                                        <td class="px-3 py-2">{{ 'Legacy Microsoft PowerPoint (binary)'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Applies to older .ppt files (not .pptx).'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.xls</code></td>
                                                        <td class="px-3 py-2"><code>xls2csv</code></td>
                                                        <td class="px-3 py-2">{{ 'Legacy Microsoft Excel (binary)'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Converts spreadsheets to CSV so text can be indexed.'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.html</code>, <code>.htm</code></td>
                                                        <td class="px-3 py-2"><code>html2text</code></td>
                                                        <td class="px-3 py-2">{{ 'HTML documents'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'Converts HTML to plain text (tags removed) before indexing.'|trans }}
                                                        </td>
                                                    </tr>

                                                    <tr class="border-t border-gray-15">
                                                        <td class="px-3 py-2"><code>.txt</code>, <code>.md</code>, <code>.csv</code></td>
                                                        <td class="px-3 py-2">{{ 'None (direct read)'|trans }}</td>
                                                        <td class="px-3 py-2">{{ 'Plain text formats'|trans }}</td>
                                                        <td class="px-3 py-2 text-gray-70">
                                                            {{ 'These formats are already plain text and do not require external converters.'|trans }}
                                                        </td>
                                                    </tr>
                                                    </tbody>
                                                </table>

                                                <p class="text-body-2 text-gray-60 mt-3 mb-0">
                                                    {{ 'Note: modern Office formats like .docx/.pptx/.xlsx require a different extraction method (ZIP/XML parsing, LibreOffice conversion, or a dedicated parser service).'|trans }}
                                                </p>
                                            </div>
                                            {# --- End block --- #}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {# MODAL overlay #}
    <div id="jsonTemplateOverlay"
         class="fixed inset-0 bg-gray-90/50 hidden z-40"></div>

    <div id="jsonTemplateModal"
         class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg border border-gray-50 shadow-2xl max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-25">
                <h2 class="text-lg font-bold text-gray-90" id="jsonTemplateModalLabel">
                    {{ 'JSON Template'|trans }}
                </h2>
                <button id="closeJsonTemplateModal" class="text-gray-50 hover:text-gray-90 text-2xl leading-none">
                    &times;
                </button>
            </div>
            <div class="p-6">
                <div id="jsonTemplateDescription" class="mb-4 text-gray-90 border-gray-20 text-body-2"></div>
                <pre id="jsonTemplateContent"
                     class="bg-gray-15 p-4 rounded text-sm text-gray-90 overflow-auto max-h-[50vh]"></pre>
            </div>
        </div>
    </div>

    {# MODAL overlay for Xapian installation help #}
    <div id="xapianHelpOverlay"
         class="fixed inset-0 bg-gray-90/50 hidden z-40"></div>

    <div id="xapianHelpModal"
         class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg border border-gray-50 shadow-2xl max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-25">
                <h2 class="text-lg font-bold text-gray-90">
                    {{ 'Installing Xapian bindings'|trans }}
                </h2>
                <button id="closeXapianHelpModal" class="text-gray-50 hover:text-gray-90 text-2xl leading-none">
                    &times;
                </button>
            </div>
            <div class="p-6 space-y-4 text-body-2 text-gray-90">
                <p>
                    {{ 'The following snippet shows an example installation of the Xapian PHP bindings on Ubuntu 25.04 with PHP 8.3. Adapt paths and versions to your own environment.'|trans }}
                </p>
                <p>
                    {{ 'Make sure you only have the PHP version you really use (for example 8.3) and avoid mixing several versions with different extension directories.'|trans }}
                </p>

                <pre class="bg-gray-15 p-4 rounded text-sm text-gray-90 overflow-auto max-h-[50vh] whitespace-pre-wrap">
sudo apt install php8.3-dev libxapian-dev

# Download a matching xapian-bindings tarball (version must match libxapian-dev)
wget https://oligarchy.co.uk/xapian/1.4.25/xapian-bindings-1.4.25.tar.xz
tar xf xapian-bindings-1.4.25.tar.xz
cd xapian-bindings-1.4.25

./configure
make
sudo make install

# Enable the extension for CLI
sudo sh -c 'echo "extension=xapian.so" > /etc/php/8.3/mods-available/xapian.ini'
cd /etc/php/8.3/cli/conf.d/
sudo ln -s /etc/php/8.3/mods-available/xapian.ini 26-xapian.ini
php -m | grep xapian   # you should see "xapian"

# Enable the extension for Apache
cd /etc/php/8.3/apache2/conf.d/
sudo ln -s /etc/php/8.3/mods-available/xapian.ini 26-xapian.ini

# Restart Apache so the module is loaded
sudo systemctl restart apache2
                </pre>

                <p class="text-gray-60">
                    {{ 'Once the extension is correctly loaded for both CLI and the web server, the search diagnostics above should report that the Xapian module is installed.'|trans }}
                </p>
            </div>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('jsonTemplateOverlay');
        const modal = document.getElementById('jsonTemplateModal');

        function closeJsonTemplateModal() {
          overlay?.classList.add('hidden');
          modal?.classList.add('hidden');
        }

        document.querySelectorAll('.show-template').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const templateId = link.dataset.templateId;

            fetch('/admin/settings/template/' + templateId)
              .then(response => response.json())
              .then(data => {
                if (data.json_example) {
                  document.getElementById('jsonTemplateModalLabel').innerText = data.variable || '{{ "JSON Template"|trans }}';
                  document.getElementById('jsonTemplateDescription').innerText = data.description || '';
                  try {
                    const jsonObject = JSON.parse(data.json_example);
                    document.getElementById('jsonTemplateContent').innerText = JSON.stringify(jsonObject, null, 2);
                  } catch (e) {
                    document.getElementById('jsonTemplateContent').innerText = data.json_example;
                  }

                  overlay?.classList.remove('hidden');
                  modal?.classList.remove('hidden');
                } else {
                  alert('{{ "Template not found."|trans }}');
                }
              });
          });
        });

        document.getElementById('closeJsonTemplateModal')?.addEventListener('click', closeJsonTemplateModal);
        overlay?.addEventListener('click', closeJsonTemplateModal);

        // Xapian help modal
        const openXapianHelp = document.getElementById('openXapianHelp');
        const xapianHelpOverlay = document.getElementById('xapianHelpOverlay');
        const xapianHelpModal = document.getElementById('xapianHelpModal');
        const closeXapianHelpModal = document.getElementById('closeXapianHelpModal');

        if (openXapianHelp && xapianHelpOverlay && xapianHelpModal && closeXapianHelpModal) {
          openXapianHelp.addEventListener('click', () => {
            xapianHelpOverlay.classList.remove('hidden');
            xapianHelpModal.classList.remove('hidden');
          });

          closeXapianHelpModal.addEventListener('click', () => {
            xapianHelpOverlay.classList.add('hidden');
            xapianHelpModal.classList.add('hidden');
          });

          xapianHelpOverlay.addEventListener('click', () => {
            xapianHelpOverlay.classList.add('hidden');
            xapianHelpModal.classList.add('hidden');
          });
        }
      });

      // MultiURL eye toggle: send AJAX to toggle access_url_changeable
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('.toggle-changeable');
        if (!btn) {
          return;
        }

        const variable = btn.dataset.variable;
        const current = btn.dataset.status === '1' ? 1 : 0;
        const next = current === 1 ? 0 : 1;

        fetch('/admin/settings/toggle_changeable', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ variable: variable, status: next })
        })
          .then(r => r.json())
          .then(data => {
            if (data.result === 1) {
              btn.dataset.status = String(next);
              btn.innerHTML = next
                ? '<i class="mdi mdi-eye text-primary text-xl"></i>'
                : '<i class="mdi mdi-eye-off text-gray-50 text-xl"></i>';
            } else if (data.error) {
              console.error('Failed to update changeable state:', data.error);
              alert(data.error);
            } else {
              console.error('Failed to update changeable state:', data);
            }
          })
          .catch(err => {
            console.error('AJAX error:', err);
          });
      });
    </script>

{% endblock %}
{% block javascripts %}
    {% set ns = app.request.get('namespace')|default('') %}
    {% set sectionLabel =
        (namespace_labels is defined and namespace_labels[ns] is defined)
        ? namespace_labels[ns]
        : (ns == 'cas' ? 'CAS' : (ns == 'lp' ? 'Learning path'|trans : (ns|capitalize)|trans))
    %}
    <script>
      window.breadcrumb = [
        { name: "{{ 'Admin'|trans|e('js') }}",    url: "/admin" },
        { name: "{{ 'Settings'|trans|e('js') }}", url: "/admin/settings" },
        { name: "{{ sectionLabel|e('js') }}" }
      ];
    </script>

    {{ parent() }}
{% endblock %}
